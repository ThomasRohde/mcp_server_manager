<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Server Manager</title>
    <!-- Bootstrap CSS via CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        /* Custom styles */
        .fade-in {
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .card {
            transition: all 0.3s ease;
        }
        .card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .status-badge {
            transition: all 0.3s ease;
        }
        .server-row {
            transition: background-color 0.3s ease;
        }
        .server-row:hover {
            background-color: rgba(0,0,0,0.03);
        }
        /* Paste indicator styles */
        .paste-indicator {
            position: absolute;
            top: 0;
            right: 0;
            padding: 5px 10px;
            background-color: rgba(0,0,0,0.05);
            border-radius: 0 0.25rem 0 0.25rem;
            font-size: 0.8rem;
        }
        .form-group {
            position: relative;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-hdd-network me-2"></i>
                MCP Server Manager
            </a>
        </div>
    </nav>
    
    <div class="container">
        <!-- Message area for feedback -->
        <div id="message-area" class="alert d-none mb-4 fade-in"></div>
        
        <!-- Top Actions Row -->
        <div class="row mb-4">
            <div class="col">
                <div class="card">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title mb-0">Claude Desktop Control</h5>
                            <p class="card-text text-muted small">Restart Claude to apply server changes</p>
                        </div>
                        <!-- Restart Claude Button -->
                        <button id="restart-claude-btn" class="btn btn-warning">
                            <i class="bi bi-arrow-repeat"></i> Restart Claude Desktop
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Servers Section -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>Registered Servers</h5>
            </div>
            <div class="card-body">
                {% if servers|length == 0 %}
                <div class="alert alert-info">
                    <i class="bi bi-info-circle-fill me-2"></i>
                    No servers registered yet. Use the form below to register your first server.
                </div>
                {% else %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Name</th>
                                <th>Status</th>
                                <th>Command</th>
                                <th>Source</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for server in servers %}
                            <tr class="server-row" data-server-id="{{ server.id }}" data-server-name="{{ server.name }}">
                                <td>
                                    <strong>{{ server.name }}</strong>
                                </td>
                                <td>
                                    {% if server.enabled_in_claude %}
                                    <span class="badge bg-success status-badge">Enabled</span>
                                    {% else %}
                                    <span class="badge bg-secondary status-badge">Disabled</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <code>{{ server.command[0] if server.command else "N/A" }}</code>
                                    {% if server.arguments|length > 0 %}
                                    <div class="small text-muted">
                                        with {{ server.arguments|length }} argument(s)
                                    </div>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if server.source_type %}
                                    <span class="badge bg-info text-dark">{{ server.source_type }}</span>
                                    {% if server.source_location %}
                                    <div class="small text-muted">{{ server.source_location }}</div>
                                    {% endif %}
                                    {% else %}
                                    <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="form-check form-switch mb-0">
                                            <input class="form-check-input server-toggle" 
                                                type="checkbox" 
                                                id="toggle-{{ server.id }}" 
                                                {% if server.enabled_in_claude %}checked{% endif %}
                                                data-server-id="{{ server.id }}">
                                            <label class="form-check-label" for="toggle-{{ server.id }}">
                                                {% if server.enabled_in_claude %}Enabled{% else %}Disabled{% endif %}
                                            </label>
                                        </div>
                                        <button class="btn btn-sm btn-danger delete-server-btn" 
                                            data-server-id="{{ server.id }}" 
                                            data-server-name="{{ server.name }}">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Register New Server Form -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-plus-circle me-2"></i>Register New Server</h5>
            </div>
            <div class="card-body">
                <form id="register-server-form" class="needs-validation" novalidate>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="name" class="form-label">Server Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="name" name="name" required 
                                pattern="^[a-zA-Z0-9_\-. ]+$" minlength="2" maxlength="50">
                            <div class="invalid-feedback">
                                Please enter a valid server name (2-50 characters, alphanumeric with spaces, dots, underscores, and hyphens).
                            </div>
                            <div class="form-text">A unique and descriptive name for this server</div>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="command_str" class="form-label">Command <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="command_str" name="command_str" required
                                minlength="1" maxlength="1024">
                            <div class="invalid-feedback">
                                Please enter the command to start the server.
                            </div>
                            <div class="form-text">The command to start the server (e.g., python, node, /path/to/executable)</div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="arguments_str" class="form-label">Arguments</label>
                            <input type="text" class="form-control" id="arguments_str" name="arguments_str" 
                                maxlength="1024">
                            <div class="form-text">Additional arguments to pass to the command (e.g., -p 8000 --debug)</div>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="environment_str" class="form-label">Environment Variables</label>
                            <textarea class="form-control" id="environment_str" name="environment_str" rows="2"
                                maxlength="2048"></textarea>
                            <div class="form-text">One KEY=VALUE per line (e.g., PORT=8000)</div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="source_type" class="form-label">Source Type</label>
                            <select class="form-select" id="source_type" name="source_type">
                                <option value="" selected>None</option>
                                <option value="local">Local</option>
                                <option value="git">Git Repository</option>
                                <option value="pip">Python Package</option>
                                <option value="npm">NPM Package</option>
                                <option value="other">Other</option>
                            </select>
                            <div class="form-text">Where this server was installed from</div>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="source_location" class="form-label">Source Location</label>
                            <input type="text" class="form-control" id="source_location" name="source_location"
                                maxlength="1024">
                            <div class="form-text">Path, URL, or package name</div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-hdd-rack me-1"></i> Register Server
                        </button>
                    </div>
                </form>
            </div>
            <div class="card-footer text-muted">
                <small><i class="bi bi-info-circle me-1"></i> After registration, the server will be verified by attempting to run it briefly.</small>
            </div>
        </div>
    </div>

    <!-- Toast container -->
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 1100">
        <div id="toast-container"></div>
    </div>

    <footer class="bg-light py-3 mt-4">
        <div class="container text-center text-muted">
            <small>MCP Server Manager v0.1.0 | <a href="https://github.com/anthropics/claude-mcp" target="_blank">Model Context Protocol</a></small>
        </div>
    </footer>

    <!-- Bootstrap JS (optional) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JavaScript for functionality -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const toastContainer = document.getElementById('toast-container');

            function showMessage(type, text, autoDismiss = true) {
                const toast = document.createElement('div');
                toast.className = `toast align-items-center text-bg-${type} border-0 fade show`;
                toast.setAttribute('role', 'alert');
                toast.setAttribute('aria-live', 'assertive');
                toast.setAttribute('aria-atomic', 'true');

                toast.innerHTML = `
                    <div class="d-flex">
                        <div class="toast-body">${text}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>`;

                toastContainer.appendChild(toast);

                const bsToast = new bootstrap.Toast(toast, { delay: 5000 });
                bsToast.show();

                if (autoDismiss) {
                    setTimeout(() => {
                        bsToast.hide();
                    }, 5000);
                }
            }

            // Clipboard paste functionality
            const registerForm = document.getElementById('register-server-form');
            if (registerForm) {
                // We need to capture the paste event at the form level, not just on inputs
                registerForm.addEventListener('paste', handleClipboardPaste);
                
                // Also add to each individual input for better coverage
                const formInputs = registerForm.querySelectorAll('input, textarea');
                formInputs.forEach(input => {
                    input.addEventListener('paste', handleClipboardPaste);
                });
                
                // Add a visual indicator that clipboard paste is available
                const formCard = registerForm.closest('.card');
                if (formCard && formCard.querySelector('.card-header')) {
                    const pasteHint = document.createElement('span');
                    pasteHint.className = 'badge bg-info text-dark ms-2';
                    pasteHint.innerHTML = '<i class="bi bi-clipboard-check"></i>CTRL+V to paste'; 
                    formCard.querySelector('.card-header h5').appendChild(pasteHint);
                }

                function handleClipboardPaste(event) {
                    console.log('Paste event detected');
                    
                    // Get clipboard content
                    const clipboardData = event.clipboardData || window.clipboardData;
                    if (!clipboardData) {
                        console.error('No clipboard data available');
                        return;
                    }
                    
                    const pastedData = clipboardData.getData('text');
                    console.log('Pasted data:', pastedData.substring(0, 50) + '...');
                    
                    if (!pastedData || pastedData.trim() === '') {
                        console.log('Paste data is empty');
                        return;
                    }
                    
                    try {
                        let jsonData = null;
                        let parsed = false;
                        let serverKey = null;
                        
                        if (pastedData.includes('"mcpServers"')) {
                            console.log('Detected mcpServers format');
                            try {
                                const fullConfig = JSON.parse(pastedData);
                                if (fullConfig && fullConfig.mcpServers) {
                                    serverKey = Object.keys(fullConfig.mcpServers)[0];
                                    jsonData = fullConfig.mcpServers[serverKey];
                                    parsed = true;
                                }
                            } catch (e) {
                                console.log('Trying to extract mcpServers section');
                                const match = pastedData.match(/"mcpServers"\s*:\s*{([^}]+})/);
                                if (match && match[1]) {
                                    const serverMatch = match[1].match(/"([^"]+)"\s*:\s*({[^}]+})/);
                                    if (serverMatch && serverMatch[1] && serverMatch[2]) {
                                        serverKey = serverMatch[1];
                                        jsonData = JSON.parse(serverMatch[2]);
                                        parsed = true;
                                    }
                                }
                            }
                        }
                        
                        if (!parsed && pastedData.includes('"command"')) {
                            console.log('Detected direct server format');
                            try {
                                const directConfig = JSON.parse(pastedData);
                                serverKey = null;
                                jsonData = directConfig;
                                parsed = true;
                            } catch (e) {
                                const match = pastedData.match(/"([^"]+)"\s*:\s*({[^}]+})/);
                                if (match && match[1] && match[2]) {
                                    serverKey = match[1];
                                    jsonData = JSON.parse(match[2]);
                                    parsed = true;
                                }
                                if (!parsed) {
                                    try {
                                        jsonData = JSON.parse(`{${pastedData}}`);
                                        parsed = true;
                                    } catch {}
                                }
                            }
                        }
                        
                        if (jsonData && jsonData.command) {
                            console.log('Valid server config found, filling form');
                            
                            // Show paste indicator
                            showPasteIndicator();
                            
                            // Prevent default paste into the current field
                            event.preventDefault();
                            event.stopPropagation();
                            
                            // Fill form fields with data from JSON
                            fillFormFromJson(jsonData, serverKey);
                            
                            // Show success message
                            showMessage('success', 'Form filled from clipboard data', true);
                            
                            return false;
                        } else {
                            console.log('Not a valid server config, no command field found');
                        }
                    } catch (e) {
                        // Not valid JSON or missing required fields - let normal paste happen
                        console.log('Error processing clipboard data:', e);
                    }
                }
                
                function showPasteIndicator() {
                    console.log('Showing paste indicator');
                    // Remove any existing indicators
                    document.querySelectorAll('.paste-indicator').forEach(el => el.remove());
                    
                    const indicator = document.createElement('div');
                    indicator.className = 'paste-indicator fade-in';
                    indicator.textContent = 'âœ“ Pasted from clipboard';
                    indicator.style.position = 'fixed';
                    indicator.style.top = '10px';
                    indicator.style.right = '10px';
                    indicator.style.backgroundColor = '#28a745';
                    indicator.style.color = 'white';
                    indicator.style.padding = '8px 16px';
                    indicator.style.borderRadius = '4px';
                    indicator.style.zIndex = '9999';
                    
                    document.body.appendChild(indicator);
                    
                    setTimeout(() => {
                        indicator.style.opacity = '0';
                        setTimeout(() => indicator.remove(), 300);
                    }, 3000);
                }
                
                function fillFormFromJson(jsonData, serverKey) {
                    const nameInput = document.getElementById('name');
                    if (serverKey) {
                        nameInput.value = serverKey;
                    } else {
                        nameInput.value = generateServerNameFromCommand(jsonData.command);
                    }
                    
                    // Fill command
                    const commandInput = document.getElementById('command_str');
                    commandInput.value = jsonData.command;
                    
                    // Fill arguments if they exist
                    const argsInput = document.getElementById('arguments_str');
                    if (jsonData.args && Array.isArray(jsonData.args)) {
                        argsInput.value = jsonData.args.join(' ');
                    }
                    
                    // Fill environment variables if they exist
                    const envInput = document.getElementById('environment_str');
                    if (jsonData.env && typeof jsonData.env === 'object') {
                        const envLines = [];
                        for (const [key, value] of Object.entries(jsonData.env)) {
                            envLines.push(`${key}=${value}`);
                        }
                        envInput.value = envLines.join('\n');
                    }
                }
                
                function generateServerNameFromCommand(command) {
                    // Extract last part of command path
                    const commandName = command.split(/[\/\\]/).pop();
                    
                    // Clean up and capitalize
                    const baseName = commandName.replace(/\.[^/.]+$/, ''); // Remove file extension
                    return baseName.charAt(0).toUpperCase() + baseName.slice(1) + ' Server';
                }
            }
            
            // Restart Claude functionality
            const restartBtn = document.getElementById('restart-claude-btn');
            if (restartBtn) {
                restartBtn.addEventListener('click', async function() {
                    console.log('Restart button clicked');
                    
                    // Show loading state
                    restartBtn.disabled = true;
                    restartBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Restarting...';
                    
                    try {
                        console.log('Making API request to /api/claude/restart');
                        // Call the restart API endpoint
                        const response = await fetch('/api/claude/restart', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        console.log('API response received:', response);
                        const data = await response.json();
                        console.log('API response data:', data);
                        
                        // Display message
                        if (response.ok) {
                            showMessage('success', data.message);
                        } else {
                            showMessage('danger', data.detail || 'An error occurred while restarting Claude Desktop', false);
                        }
                    } catch (error) {
                        // Handle network errors
                        console.error('Error during API call:', error);
                        showMessage('danger', 'Network error: Failed to connect to the server', false);
                    } finally {
                        // Reset button state
                        restartBtn.disabled = false;
                        restartBtn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Restart Claude Desktop';
                    }
                });
            }
            
            // Server toggle functionality
            const serverToggles = document.querySelectorAll('.server-toggle');
            serverToggles.forEach(toggle => {
                toggle.addEventListener('change', async function() {
                    // Get server info from data attributes
                    const serverId = this.getAttribute('data-server-id');
                    const serverRow = document.querySelector(`tr[data-server-id="${serverId}"]`);
                    const serverName = serverRow ? serverRow.getAttribute('data-server-name') : 'Unknown server';
                    const enabled = this.checked;
                    
                    // Apply visual indication of pending state
                    serverRow.classList.add('table-warning');
                    
                    // Update label text immediately for better UX
                    const label = document.querySelector(`label[for="toggle-${serverId}"]`);
                    if (label) {
                        label.textContent = enabled ? 'Enabling...' : 'Disabling...';
                    }
                    
                    // Update status badge
                    const statusBadge = serverRow.querySelector('.badge');
                    if (statusBadge) {
                        statusBadge.className = 'badge bg-warning text-dark status-badge';
                        statusBadge.textContent = 'Updating...';
                    }
                    
                    // Disable toggle during API call
                    this.disabled = true;
                    
                    try {
                        // Make API call to update server status
                        const response = await fetch(`/api/servers/${serverId}/status`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ enabled: enabled })
                        });
                        
                        const data = await response.json();
                        
                        // Handle response
                        if (response.ok) {
                            // Remove pending visual state
                            serverRow.classList.remove('table-warning');
                            
                            // Update status badge
                            if (statusBadge) {
                                statusBadge.className = enabled ? 'badge bg-success status-badge' : 'badge bg-secondary status-badge';
                                statusBadge.textContent = enabled ? 'Enabled' : 'Disabled';
                            }
                            
                            // Update label
                            if (label) {
                                label.textContent = enabled ? 'Enabled' : 'Disabled';
                            }
                            
                            // Show success message
                            showMessage('success', data.message);
                        } else {
                            // Remove pending visual state
                            serverRow.classList.remove('table-warning');
                            
                            // Revert toggle state on error
                            this.checked = !enabled;
                            if (label) {
                                label.textContent = !enabled ? 'Enabled' : 'Disabled';
                            }
                            
                            // Revert status badge
                            if (statusBadge) {
                                statusBadge.className = !enabled ? 'badge bg-success status-badge' : 'badge bg-secondary status-badge';
                                statusBadge.textContent = !enabled ? 'Enabled' : 'Disabled';
                            }
                            
                            // Show error message
                            showMessage('danger', data.detail || 'Failed to update server status', false);
                        }
                    } catch (error) {
                        // Handle network errors
                        console.error('Error during API call:', error);
                        
                        // Remove pending visual state
                        serverRow.classList.remove('table-warning');
                        
                        // Revert toggle state
                        this.checked = !enabled;
                        if (label) {
                            label.textContent = !enabled ? 'Enabled' : 'Disabled';
                        }
                        
                        // Revert status badge
                        if (statusBadge) {
                            statusBadge.className = !enabled ? 'badge bg-success status-badge' : 'badge bg-secondary status-badge';
                            statusBadge.textContent = !enabled ? 'Enabled' : 'Disabled';
                        }
                        
                        // Show error message
                        showMessage('danger', 'Network error: Failed to connect to the server', false);
                    } finally {
                        // Re-enable toggle
                        this.disabled = false;
                    }
                });
            });
            
            // Server Registration Form Submission
            const registerServerForm = document.getElementById('register-server-form');
            if (registerServerForm) {
                // Enable Bootstrap form validation
                registerServerForm.addEventListener('submit', function(event) {
                    if (!this.checkValidity()) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    this.classList.add('was-validated');
                });
                
                registerServerForm.addEventListener('submit', async function(event) {
                    // Prevent default form submission
                    event.preventDefault();
                    
                    // Check form validity (Bootstrap validation)
                    if (!this.checkValidity()) {
                        return;
                    }
                    
                    // Get the submit button for changing its state
                    const submitButton = registerServerForm.querySelector('button[type="submit"]');
                    
                    // Show loading state
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Registering...';
                    
                    // Create FormData object from the form
                    const formData = new FormData(registerServerForm);
                    
                    try {
                        // Show registering message
                        showMessage('info', `Registering server "${formData.get('name')}"... This may take a moment as the server command is verified.`, false);
                        
                        // Send POST request to the server registration API
                        const response = await fetch('/api/servers', {
                            method: 'POST',
                            body: formData
                        });
                        
                        const data = await response.json();
                        
                        // Handle the response
                        if (response.ok) {
                            // Show success message
                            showMessage('success', data.message);
                            
                            // Reset the form and remove validation styling
                            registerServerForm.reset();
                            registerServerForm.classList.remove('was-validated');
                            
                            // Refresh the page after a short delay to show the new server
                            setTimeout(() => {
                                window.location.reload();
                            }, 1500);
                        } else {
                            // Show error message
                            showMessage('danger', data.detail || 'Failed to register server', false);
                        }
                    } catch (error) {
                        // Handle network errors
                        console.error('Error during API call:', error);
                        showMessage('danger', 'Network error: Failed to connect to the server', false);
                    } finally {
                        // Reset button state
                        submitButton.disabled = false;
                        submitButton.innerHTML = '<i class="bi bi-hdd-rack me-1"></i> Register Server';
                    }
                });
            }
            
            // Server deletion functionality
            const deleteButtons = document.querySelectorAll('.delete-server-btn');
            deleteButtons.forEach(button => {
                button.addEventListener('click', async function() {
                    // Get server info from data attributes
                    const serverId = this.getAttribute('data-server-id');
                    const serverName = this.getAttribute('data-server-name');
                    const serverRow = document.querySelector(`tr[data-server-id="${serverId}"]`);
                    
                    console.log('Delete clicked for server:', { id: serverId, name: serverName });
                    
                    // Ask for confirmation
                    if (!confirm(`Are you sure you want to delete "${serverName}"? This cannot be undone.`)) {
                        return;
                    }
                    
                    // Apply visual indication of pending state
                    if (serverRow) {
                        serverRow.classList.add('table-danger');
                    }
                    
                    // Disable button during API call
                    this.disabled = true;
                    this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
                    
                    try {
                        // Make API call to delete server - ensure the ID is properly encoded
                        // Remove any whitespace and ensure proper encoding
                        const encodedId = encodeURIComponent(String(serverId).trim());
                        console.log(`Sending delete request for server ID: ${encodedId}`);
                        
                        const url = `/api/servers/${encodedId}`;
                        console.log(`Delete URL: ${url}`);
                        
                        const response = await fetch(url, {
                            method: 'DELETE'
                            // Removed Content-Type header as it's not needed for DELETE requests with no body
                        });
                        
                        // Log the response for debugging
                        console.log('Delete response status:', response.status);
                        let data;
                        try {
                            data = await response.json();
                            console.log('Delete response data:', data);
                        } catch (parseError) {
                            console.error('Error parsing response JSON:', parseError);
                            data = { detail: 'Could not parse response from server' };
                        }
                        
                        // Handle response
                        if (response.ok) {
                            // Show success message
                            showMessage('success', data.message || 'Server deleted successfully');
                            
                            // Remove the server row with a fade effect
                            if (serverRow) {
                                serverRow.style.transition = 'opacity 0.5s ease';
                                serverRow.style.opacity = '0';
                                setTimeout(() => {
                                    serverRow.remove();
                                    
                                    // If no more servers, refresh to show the empty state
                                    const remainingServers = document.querySelectorAll('.server-row');
                                    if (remainingServers.length === 0) {
                                        window.location.reload();
                                    }
                                }, 500);
                            }
                        } else {
                            // Remove pending visual state
                            if (serverRow) {
                                serverRow.classList.remove('table-danger');
                            }
                            
                            // Show error message
                            showMessage('danger', data.detail || `Failed to delete server (Status: ${response.status})`, false);
                            
                            // Reset button
                            this.innerHTML = '<i class="bi bi-trash"></i>';
                            this.disabled = false;
                        }
                    } catch (error) {
                        // Handle network errors
                        console.error('Error during API call:', error);
                        
                        // Remove pending visual state
                        if (serverRow) {
                            serverRow.classList.remove('table-danger');
                        }
                        
                        // Reset button
                        this.innerHTML = '<i class="bi bi-trash"></i>';
                        this.disabled = false;
                        
                        // Show error message
                        showMessage('danger', 'Network error: Failed to connect to the server', false);
                    }
                });
            });
        });
    </script>
</body>
</html>